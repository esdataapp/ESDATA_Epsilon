# üîß AJUSTES CR√çTICOS - Dashboard ZMG
## Consolidaci√≥n de Revisiones ChatGPT + Claude

---

## üìã **RESUMEN DE PROBLEMAS IDENTIFICADOS**

### üö® **CR√çTICOS (Resolver AHORA)**
1. **Schema geoespacial inconsistente** - `POINT` vs `geometry(Point,4326)`
2. **Falta de series temporales** - No hay `period_month` en `market_stats`
3. **MVP demasiado ambicioso** - 4 vistas completas no es MVP
4. **Performance en mapas** - 25K puntos crashear√°n m√≥viles
5. **Cache strategy incompleta** - TTL muy corto para overview

### ‚ö†Ô∏è **IMPORTANTES (Resolver en M1)**
1. **Falta tabla de bins** - Para histogramas pre-calculados
2. **Amenidades sin impacto** - Falta an√°lisis de lift
3. **Correlaciones incompletas** - Solo estructura, sin implementaci√≥n
4. **B√∫squeda de colonias** - Sin √≠ndice trigram
5. **Paginaci√≥n ausente** - Cr√≠tico para listas grandes

---

## üõ†Ô∏è **PLAN DE AJUSTES INMEDIATOS**

### **1. CORRECCI√ìN DE SCHEMA (30 minutos)**

#### A. Tipo Geoespacial
```sql
-- Cambiar de POINT a geometry(Point,4326)
ALTER TABLE listings_processed 
  DROP COLUMN location,
  ADD COLUMN location geometry(Point, 4326);

CREATE INDEX idx_listings_location ON listings_processed USING GIST (location);
```

#### B. Series Temporales
```sql
-- Agregar period_month para tendencias
ALTER TABLE market_stats ADD COLUMN period_month DATE;

-- Nuevo constraint √∫nico
ALTER TABLE market_stats 
  ADD UNIQUE (geo_level, geo_id, property_type, operation, period_month);
```

#### C. Tabla de Bins
```sql
CREATE TABLE histogram_bins (
  variable VARCHAR(50) NOT NULL,
  geo_level VARCHAR(20) NOT NULL,
  geo_id VARCHAR(100) NOT NULL,
  property_type VARCHAR(30),
  operation VARCHAR(20),
  bin_edges DECIMAL[] NOT NULL,
  bin_counts INTEGER[] NOT NULL,
  calculated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(variable, geo_level, geo_id, property_type, operation)
);
```

### **2. REDEFINICI√ìN DEL MVP (1 hora)**

#### MVP Real - Solo 2 Vistas
```typescript
const MVP_REAL = {
  vistas: [
    {
      nombre: "Inicio",
      componentes: [
        "3 KPIs principales (precio promedio, total propiedades, cambio 30d)",
        "1 gr√°fica de barras (top 10 colonias)",
        "Mini mapa est√°tico (imagen)"
      ]
    },
    {
      nombre: "Explorar", 
      componentes: [
        "Mapa con clustering (m√°ximo 100 puntos visibles)",
        "3 filtros b√°sicos (precio, tipo, colonia)",
        "Lista paginada (20 items por p√°gina)"
      ]
    }
  ],
  tiempo_desarrollo: "2-3 semanas",
  endpoints_necesarios: ["/overview", "/filtered", "/map-clusters"]
};
```

### **3. OPTIMIZACI√ìN DE CACHE (15 minutos)**

```typescript
// Ajustar TTL seg√∫n recomendaciones
const CACHE_STRATEGY_OPTIMIZADA = {
  overview: 6 * 60 * 60,      // 6 horas (era 15 min)
  filtered: 30 * 60,          // 30 minutos (era 5 min)
  correlations: 24 * 60 * 60, // 24 horas (era 30 min)
  clusters: 24 * 60 * 60,     // 24 horas (era 1 hora)
  
  // Nuevos
  histogram: 12 * 60 * 60,    // 12 horas
  amenities: 24 * 60 * 60     // 24 horas
};
```

### **4. CLUSTERING DE MAPAS (45 minutos)**

```typescript
// Configuraci√≥n obligatoria para Mapbox
const MAP_CONFIG = {
  cluster: true,
  clusterMaxZoom: 14,
  clusterRadius: 50,
  maxPointsVisible: 100,
  
  // Estrategia por zoom level
  zoomLevels: {
    0-10: "mostrar_solo_municipios",
    11-13: "mostrar_colonias_agregadas", 
    14-18: "mostrar_propiedades_individuales"
  }
};
```

---

## üìä **NUEVOS ENDPOINTS NECESARIOS**

### **1. Histogramas Pre-calculados**
```typescript
// GET /api/stats/histogram
interface HistogramRequest {
  variable: 'price' | 'surface' | 'pxm2';
  geo_level: 'zmg' | 'municipality' | 'colony';
  geo_id?: string;
  property_type?: string[];
  operation?: string[];
}

interface HistogramResponse {
  bins: Array<{
    min: number;
    max: number;
    count: number;
    label: string;
  }>;
  meta: {
    total_count: number;
    method: 'freedman_diaconis';
    calculated_at: string;
  };
}
```

### **2. Clustering de Mapa**
```typescript
// GET /api/geo/clusters
interface MapClustersRequest {
  bounds: {
    north: number;
    south: number; 
    east: number;
    west: number;
  };
  zoom: number;
  filters?: FilterRequest;
}

interface MapClustersResponse {
  type: 'FeatureCollection';
  features: Array<{
    type: 'Feature';
    properties: {
      cluster: boolean;
      cluster_id?: number;
      point_count?: number;
      point_count_abbreviated?: string;
      // Para puntos individuales
      property_id?: string;
      price?: number;
      property_type?: string;
    };
    geometry: {
      type: 'Point';
      coordinates: [number, number];
    };
  }>;
}
```

### **3. Amenidades con Impacto**
```typescript
// GET /api/analysis/amenities
interface AmenitiesResponse {
  data: Array<{
    amenity_name: string;
    category: string;
    prevalence_rate: number;
    price_lift_percentage: number;
    confidence_interval: [number, number];
    sample_size: number;
    significance: 'high' | 'medium' | 'low';
  }>;
  meta: {
    segment: string;
    calculated_at: string;
  };
}
```

---

## üéØ **CRONOGRAMA AJUSTADO (REALISTA)**

### **Semana 1: Correcciones Cr√≠ticas**
- ‚úÖ Ajustar schema de base de datos
- ‚úÖ Implementar MVP real (2 vistas)
- ‚úÖ Configurar clustering en mapas
- ‚úÖ Optimizar cache strategy

### **Semana 2: MVP Funcional**
- ‚úÖ Endpoints b√°sicos (/overview, /filtered, /clusters)
- ‚úÖ Frontend b√°sico con 2 vistas
- ‚úÖ Filtros b√°sicos funcionando
- ‚úÖ Deploy en staging

### **Semana 3: Optimizaci√≥n**
- ‚úÖ Histogramas pre-calculados
- ‚úÖ B√∫squeda de colonias con trigram
- ‚úÖ Paginaci√≥n en listas
- ‚úÖ Performance tuning

### **Semana 4: Extensi√≥n**
- ‚úÖ Vista de Segmentos (b√°sica)
- ‚úÖ An√°lisis de amenidades
- ‚úÖ Mobile optimization
- ‚úÖ Testing

### **Semana 5-8: Features Avanzadas**
- ‚úÖ Correlaciones completas
- ‚úÖ Clustering de colonias
- ‚úÖ Vista Anal√≠tica completa
- ‚úÖ Polish y documentaci√≥n

---

## üö® **DECISIONES T√âCNICAS PENDIENTES**

### **1. Tipo Geoespacial**
**Pregunta**: ¬ø`geometry(Point,4326)` o `geography(Point,4326)`?

**Recomendaci√≥n**: `geometry(Point,4326)`
- Mejor performance para consultas de bounding box
- Mapbox espera coordenadas planas
- Suficiente precisi√≥n para ZMG

### **2. Granularidad de Series**
**Pregunta**: ¬øSeries mensuales por colonia desde el inicio?

**Recomendaci√≥n**: Estrategia escalonada
```sql
-- Inmediato: ZMG y municipios
INSERT INTO market_stats (geo_level, period_month, ...)
VALUES ('zmg', '2025-09-01', ...);

-- Despu√©s: Colonias con n >= 30
INSERT INTO market_stats (geo_level, period_month, ...)
SELECT 'colony', '2025-09-01', ...
FROM listings_processed 
GROUP BY colony 
HAVING COUNT(*) >= 30;
```

### **3. Stack Simplificado**
**Consideraci√≥n Claude**: ¬øPor qu√© no Supabase completo?

**Evaluaci√≥n**:
- ‚úÖ **Mantener NestJS**: Mayor control sobre l√≥gica de negocio
- ‚úÖ **Usar Supabase solo para DB**: PostgreSQL + PostGIS managed
- ‚úÖ **Redis separado**: Para cache avanzado

---

## üìù **PR√ìXIMAS ACCIONES INMEDIATAS**

### **Hoy (2 horas)**
1. Ejecutar script de migraci√≥n de schema
2. Reducir scope del MVP a 2 vistas
3. Configurar clustering en componente de mapa

### **Esta semana**
1. Implementar endpoints b√°sicos
2. Frontend MVP funcional
3. Deploy en staging

### **Pr√≥xima semana**
1. Optimizaciones de performance
2. Histogramas y amenidades
3. Testing con datos reales

---

**¬øQuieres que implemente alguno de estos ajustes espec√≠ficos ahora mismo?**
