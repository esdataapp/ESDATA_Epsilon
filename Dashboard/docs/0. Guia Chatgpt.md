# Guía práctica — Dashboard ZMG: diseño, datos y producto

> Objetivo: crear un dashboard **móvil‑first**, limpio y rápido, que sirva tanto a un usuario básico como a un equipo corporativo para entender el mercado inmobiliario de la ZMG y tomar decisiones.

---

## 1) Principios rectores (UX + producto)
- **Móvil primero**: navegación con pulgar, controles inferiores (bottom sheet + tabs). Área táctil ≥ 44 px.
- **Menos es más**: 1 idea por pantalla. Evita saturar; usa progresión: *vislumbra → explora → detalla → exporta*.
- **Velocidad percibida**: respuestas < 200 ms para cambios de filtro (usa caché y pre‑agregados).
- **Lenguaje claro**: cifra + etiqueta + dirección (↑/↓) + contexto (“vs. mes anterior”).
- **Narrativa**: cada vista responde una pregunta de negocio. Títulos que completan la frase “Hoy sé que…”.
- **Accesibilidad**: contraste AA, tooltips con descripciones, colores no dependientes del rojo/verde.

---

## 2) Arquitectura recomendada (sencilla pero potente)
**Front**: Vite + React + Tailwind + TypeScript, **shadcn/ui** (componentes), **lucide-react** (iconos), **Recharts** (gráficas), **Mapbox GL** (mapa), **Zustand** (estado liviano), **TanStack Query** (data fetching/caché), **react-hook-form + zod** (validación filtros).

**Back/API**: NestJS + Prisma sobre **PostgreSQL (Supabase)** con **PostGIS**. Materialized views para agregados. CRON/Prefect cada 15 días.

**Capa analítica offline (Python)**: pandas/Polars + DuckDB. Genera **tablas oro** y artefactos: correlaciones, clústeres, cuantiles/estratos, outliers.

**Formato datos**: Parquet/Arrow (columnar) para ETL; API sirve JSON compacto (≤100 KB por request). CDN/edge cache (Vercel) + ETag.

---

## 3) Qué pre‑calcular vs. qué calcular en el dashboard
**Pre‑calcular (Python/DB):**
- Estadísticos por **(ciudad/municipio/colonia, tipo_propiedad, operación)**: `n, mean, median, p10/p25/p50/p75/p90, iqr, sd, min_trimado, max_trimado, skew, kurtosis` para **precio, superficie, pxm2**.
- **Estratos** de precio/superficie/pxm2 (cuantiles globales por categoría y también por ciudad). Guardar puntos de corte.
- **Correlaciones**: Pearson/Spearman (numéricas), Cramer’s V / Theil’s U (categóricas), **mutual information**. 1 matriz por (tipo_propiedad, operación) y a nivel ZMG, municipio y top‑k colonias.
- **Clustering**: K‑Means (estandarizado) y **HDBSCAN** (densidad) para perfiles de colonias y de listings; nombrar clústeres (e.g., “Prime vertical premium”).
- **Hedónica/amenidades**: regresión lineal robusta o Lasso por segmento para estimar *lift* de amenidades (piscina, roof, gym…).
- **Series**: mensualización (mediana PxM2, conteo, DOM si lo tienes).

**Calcular en cliente (ligero):**
- Derivados visuales: % variación, índices base=100, formateo, pequeñas combinaciones entre filtros que no cambian los agregados base.

**Regla simple**: si cruza >3 dimensiones o toca estadísticos pesados → **API**. Si es puramente presentación → **cliente**.

---

## 4) Modelo de datos (resumen)
**Tabla `listings_clean`** (nivel propiedad): id, fecha, fuente, operación, tipo_propiedad, ciudad, municipio, colonia, lat/lon, precio, superficie_m2, pxm2, recámaras, baños, estacionamientos, amenidades[], antigüedad, niveles, etc.

**Tabla `agg_stats`** (nivel agregado):
- Keys: `geo_level (ciudad/municipio/colonia)`, `geo_id`, `tipo_propiedad`, `operacion`, `periodo (YYYY-MM)` opcional
- Métricas: estadísticos de **precio, superficie, pxm2** (ver sección 3)

**Tabla `bins`**: cortes de estratos por variable y segmento (ej. pxm2, superficie, precio).

**Tabla `corr_mats`**: por segmento (keys) + matriz compacta (lista de triplas `var_i, var_j, rho, pvalue`).

**Tabla `clusters`**: por segmento; `cluster_id`, nombre, centroide, variables top, lista de colonias/listings.

**Tabla `amenity_lift`**: `amenidad`, `lift_%`, `confianza`, `segmento`.

---

## 5) Diseño de interfaz (wireframe textual)
**Header minimal**: logo + selector rápido de **Zona** (ZMG/municipio/colonia) + botón “Filtros”.

**Bottom nav (4 tabs)**:
1. **Inicio** (Insights): tarjetas con KPIs y hallazgos autogenerados.
2. **Explorar**: mapa + lista; chips de filtros; tooltips.
3. **Segmentos**: *Segment Builder* y comparador lado a lado.
4. **Analítica**: correlaciones, clústeres, amenidades.

**Panel de filtros (bottom sheet)**:
- Selects: *Tipo de propiedad*, *Operación*, *Ciudad/Municipio/Colonia* (búsqueda con debounce).
- Sliders: **Precio**, **Superficie**, **PxM2** (sincronizados con estratos guardados).
- Checkboxes: amenidades comunes; switches de *incluir outliers*.
- Botones: *Aplicar*, *Limpiar*, *Guardar Segmento*.

**Patrones clave**:
- **Chips activos** encima del contenido (tap para editar/quitar).
- **Skeleton loaders** de altura fija.
- **Tooltips** para definiciones (PxM2, estratos, iqr…).

---

## 6) Vistas y gráficas recomendadas
**Inicio (Insights)**
- *KPIs*: Mediana PxM2, Mediana precio, Conteo listings, % cambio 30/90 días.
- *Tarjetas de hallazgos* (autoinsights): “Top 5 colonias ↑ PxM2”, “Amenidad con mayor *lift* este mes”, “Clúster con mayor absorción”.
- *Gráficas*: Combinada (barras conteo + línea PxM2), Top‑N barras horizontales, Mini‑sparkline por colonia.

**Explorar**
- Mapa coroplético PxM2 por colonia + pins opcionales. Lista con tarjetas resumidas.
- Histograma (precio/superficie/pxm2) con brush para ajustar sliders.
- Dispersión Superficie vs Precio con línea de tendencia (robusta) y selector de subsegmento.

**Segmentos**
- Constructor con presets: “1R/1‑1.5B”, “2R/2‑2.5B”, “3R/3‑3.5B”.
- Devolver: rangos (p25‑p75), mediana, conteo, PxM2, distribución por colonia.
- Comparar 2–3 segmentos (columnas lado a lado + barras apiladas por colonia).

**Analítica**
- **Correlación**: heatmap (tap para detalles), tabla top pares por |ρ| con advertencias (sesgo, multicolinealidad).
- **Clústeres**: tarjetas por clúster con descripción legible (“Vertical premium: alta densidad, amenidades completas…”), radar chart de variables normalizadas.
- **Amenidades**: ranking de *lift* con barras y barras de error.

**Otras**: Cajas y bigotes por colonia; Cascada para *construcción del precio* (hedónica); Embudo para recorrido inventario→visitas→cierres (si hay).

---

## 7) Filtros, estratos y segmentaciones (definiciones)
- **Estratos cuantiles** por `tipo_propiedad+operación`: usa p10/p25/p50/p75/p90 como cortes. Guarda en `bins`.
- **Outliers**: define por IQR (1.5×) y por z‑score robusto (MAD). Bandera y excluye por defecto, opción “incluir”.
- **Segment Builder (JSON)**:
```json
{
  "tipo_propiedad": ["Departamento"],
  "operacion": ["Venta"],
  "recamaras": {"min": 1, "max": 1},
  "banos": {"values": [1, 1.5]},
  "precio": {"min": 900000, "max": 2200000},
  "pxm2": {"estrato": "p25-p75"},
  "colonias": ["Arcos Vallarta", "Providencia"],
  "amenidades": ["estacionamiento", "gym"],
  "outliers": false
}
```
- Devuelve **rangos recomendados**: para cada variable, reporta p25‑p75 y la mediana; incluye conteos y cobertura.

---

## 8) Endpoints sugeridos (API)
- `GET /agg` → parámetros: `geo_level, geo_id?, tipo_propiedad[], operacion[], var (precio|superficie|pxm2), periodo?` → devuelve estadísticos + cortes.
- `GET /hist` → buckets ya pre‑cocinados según `bins` y filtros.
- `GET /corr` → matriz de correlación para segmento actual.
- `GET /clusters` → definición de clústeres + métricas por clúster.
- `GET /amenities` → tabla de *lift* por amenidad (con CI).
- `POST /segment` → guarda/recupera segmentos del usuario.

**Respuesta estándar**: `{ meta: {filters, ts, rows, cached}, data: [...] }` + `ETag`.

---

## 9) Rendimiento y calidad de datos
- **Materialized views** por (geo_level, tipo_propiedad, operacion). Refrescar en batch.
- **Índices**: `(tipo_propiedad, operacion, geo_id)`, GIN para amenidades.
- **Paginar Top‑N** en listas (lazy load). **Debounce** 250 ms en búsqueda de colonias.
- **Validación**: porcentaje de nulos por variable, cobertura geográfica, *data freshness*. Mostrar badge “Actualizado: AAAA‑MM‑DD”.

---

## 10) Diseño visual (marketing sutil)
- **Tipografía**: Inter/Geist. Escala 12/14/16/20/24/32. Espaciado 4‑8‑12‑16.
- **Color**: base neutra; una primaria (azul/turquesa) para acentos; paleta divergente para variaciones (+/‑).
- **Vacíos útiles**: estados “sin datos” con recomendación (e.g., “Amplía superficie a 40‑120 m²”).
- **Confianza**: microcopys “mediana p50 (robusta a outliers)”. Fuentes/metodología accesibles.
- **Exportables**: PNG/PDF y CSV/Parquet de lo visible.

---

## 11) Pipeline de cálculo (cada 15 días)
1. **Ingesta y limpieza** (regex direcciones, normalizar baños 1.5, amenidades a one‑hot).
2. **Geo**: validar coordenadas, asignar colonia (join espacial), calidades.
3. **Outliers & estratos** por segmento.
4. **Agregación** → `agg_stats` y `bins`.
5. **Analítica** → `corr_mats`, `clusters`, `amenity_lift`.
6. **Publicación**: refrescar vistas/materialized views; invalidar cachés; snapshot con versión.

---

## 12) Buenas prácticas de gráficas
- Columnas/barras **ordenadas** por valor; etiquetas si ≤12 barras.
- Líneas: máximo 3‑4 series; marca puntos clave.
- Histogramas: 20–40 bins o `Freedman‑Diaconis`. Muestra p25/p50/p75.
- Cajas y bigotes: ideal para comparar colonias; resalta outliers en color tenue.
- Dispersión: agrega *trendline* robusta (Theil‑Sen) para no sesgar por outliers.
- Radar para clústeres: máximo 6‑8 ejes; normaliza [0,1].

---

## 13) Seguridad y versiones
- Versiona artefactos analíticos `vYYYYMMDD` y expón en `/meta`.
- Log de cambios visible (cortes de estratos, metodología).
- Minimiza PII; usa IDs internos para listings.

---

## 14) Plan de entrega incremental (sugerido)
- **M0 (Semana 1)**: Inicio (KPIs + Top colonias), filtros básicos, `/agg` y `/hist` con estratos.
- **M1**: Explorar (mapa + hist + dispersión), guardar segmentos.
- **M2**: Analítica (corr/cluster/amenities) + exportables.
- **M3**: Comparador de segmentos + storytelling semanal (autoinsights).

---

## 15) Checklist de aceptación por vista
**Inicio**: KPIs cargan < 200 ms, tarjetas ordenadas por impacto, tooltips claros.
**Explorar**: mapa fluido, histograma sincroniza sliders, lista ordenable.
**Segmentos**: guardar/recuperar presets, comparar 2‑3 segmentos sin lag.
**Analítica**: heatmap legible, clústeres con descripciones en lenguaje natural, amenidades con CI.

---

## 16) FAQs rápidas
- **¿Python o dashboard calcula todo?** → Pre‑agrega en Python/DB (90%). Cliente solo formatea/deriva.
- **¿CSV o DB?** → DB (Supabase) para servir; CSV/Parquet para ETL interno y exportables.
- **¿Cargar todo al cliente?** → No. Siempre por query con caché y compresión.

---

## 17) Anexo: esquema mínimo de respuesta `/agg`
```json
{
  "meta": {
    "filters": {"geo_level":"colonia","tipo_propiedad":["Departamento"],"operacion":["Venta"]},
    "ts": "2025-09-15",
    "cached": true
  },
  "data": [
    {
      "geo_id": "COL_123",
      "label": "Providencia",
      "n": 148,
      "precio": {"p25": 2150000, "median": 2890000, "p75": 3780000},
      "superficie": {"p25": 68, "median": 88, "p75": 112},
      "pxm2": {"p25": 31000, "median": 35500, "p75": 40200},
      "outlier_rate": 0.06
    }
  ]
}
```

---

### Cierre
Mantén la promesa: **rápido, simple, confiable**. Empieza con pocas vistas que respondan preguntas claras y ve sumando potencia analítica detrás del telón. Este blueprint te deja el camino pavimentado para iterar sin rehacer el front cada ciclo de datos.

